<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Happy Diwali â€” From Anjali</title>
<style>
  html,body { height:100%; margin:0; background: radial-gradient(ellipse at center, #04021a 0%, #000 60%); overflow:hidden; font-family: 'Segoe UI', Roboto, sans-serif; color: #fff }
  #overlay { position: absolute; left: 0; right:0; top:0; pointer-events:none; text-align:center; padding-top:18px; z-index:12 }
  .card { display:inline-block; background: rgba(255,255,255,0.06); padding:12px 18px; border-radius:12px; pointer-events:auto; backdrop-filter: blur(6px); }
  #title { font-size:20px; font-weight:700; letter-spacing:0.4px }
  #sub { font-size:13px; color:#ffd59e; margin-top:6px }
  #controls { position:absolute; right:14px; top:14px; z-index:13; pointer-events:auto; }
  #controls button { background: rgba(255,255,255,0.06); border:0; color:#fff; padding:8px 10px; border-radius:10px; margin-left:8px; font-weight:600 }
  #hint { position:absolute; bottom:18px; left:0; right:0; text-align:center; font-size:13px; color:#ccc; z-index:10 }
  #diya { position:absolute; left:20px; bottom:18px; z-index:11; pointer-events:none; opacity:0.95 }
  canvas { display:block }
  .small { font-size:12px; color:#ddd }
</style>
</head>
<body>
<div id="overlay">
  <div class="card" id="messageCard">
    <div id="title">ðŸŽ† Wishing you light, love & laughter â€“ Anjali ðŸ’«</div>
    <div id="sub">Tap anywhere â€” or press Launch â€” to light the sky with crackers!</div>
  </div>
</div>

<div id="controls">
  <button id="launchBtn">Launch ðŸŽ‡</button>
  <button id="musicToggle">Play Beats ðŸ”Š</button>
</div>

<div id="hint">Best viewed in full-screen. Tip: tap the screen for more bursts.</div>

<!-- simple diya ornament -->
<svg id="diya" width="110" viewBox="0 0 200 120" xmlns="http://www.w3.org/2000/svg">
  <defs>
    <radialGradient id="g1" cx="50%" cy="30%" r="70%">
      <stop offset="0%" stop-color="#ffd77a" stop-opacity="1"/>
      <stop offset="60%" stop-color="#ffb74d" stop-opacity="0.9"/>
      <stop offset="100%" stop-color="#ff8a00" stop-opacity="0.7"/>
    </radialGradient>
  </defs>
  <ellipse cx="100" cy="90" rx="85" ry="18" fill="#2a1b00" opacity="0.25"/>
  <path d="M16 86 C40 30, 160 30, 184 86 Q100 120 16 86 Z" fill="url(#g1)"/>
  <circle cx="100" cy="46" r="8" fill="#fff9d2" opacity="0.9"/>
  <path d="M100 36 C110 40, 112 28, 100 22 C88 28, 90 40, 100 36 Z" fill="#ffd86b"/>
</svg>

<script src="https://unpkg.com/three@0.150.1/build/three.min.js"></script>
<script>
/* Personalized Diwali page
   - Fireworks (Three.js)
   - Synthesized festive beats (WebAudio)
   - Personalized heading
*/

let scene, camera, renderer, clock, particleSystem, particleGeometry;
const MAX_PARTICLES = 5000;
let particleState = Array(MAX_PARTICLES).fill(null);
let particles = [];
const GRAVITY = new THREE.Vector3(0, -0.018, 0);
const PARTICLE_LIFE = 120;

init();
animate();

function init(){
  clock = new THREE.Clock();
  scene = new THREE.Scene();

  const w = window.innerWidth, h = window.innerHeight;
  camera = new THREE.PerspectiveCamera(60, w/h, 0.1, 1000);
  camera.position.set(0, 18, 40);

  renderer = new THREE.WebGLRenderer({antialias:true, alpha:true});
  renderer.setSize(w,h);
  renderer.setPixelRatio(window.devicePixelRatio || 1);
  document.body.appendChild(renderer.domElement);

  const hemi = new THREE.HemisphereLight(0x9999ff, 0x080820, 0.5);
  scene.add(hemi);

  particleGeometry = new THREE.BufferGeometry();
  const positions = new Float32Array(MAX_PARTICLES*3);
  const colors = new Float32Array(MAX_PARTICLES*3);
  const alphas = new Float32Array(MAX_PARTICLES);
  const sizes = new Float32Array(MAX_PARTICLES);

  particleGeometry.setAttribute('position', new THREE.BufferAttribute(positions, 3));
  particleGeometry.setAttribute('customColor', new THREE.BufferAttribute(colors, 3));
  particleGeometry.setAttribute('alpha', new THREE.BufferAttribute(alphas, 1));
  particleGeometry.setAttribute('size', new THREE.BufferAttribute(sizes, 1));

  const material = new THREE.ShaderMaterial({
    transparent:true, depthWrite:false,
    vertexShader: `
      attribute float alpha;
      attribute float size;
      attribute vec3 customColor;
      varying float vAlpha;
      varying vec3 vColor;
      void main(){
        vAlpha = alpha;
        vColor = customColor;
        vec4 mv = modelViewMatrix * vec4(position, 1.0);
        gl_PointSize = size * (300.0 / -mv.z);
        gl_Position = projectionMatrix * mv;
      }
    `,
    fragmentShader: `
      varying float vAlpha;
      varying vec3 vColor;
      void main(){
        float dist = length(gl_PointCoord - vec2(0.5));
        float mask = smoothstep(0.5, 0.45, dist);
        gl_FragColor = vec4(vColor, vAlpha * mask);
      }
    `
  });

  particleSystem = new THREE.Points(particleGeometry, material);
  scene.add(particleSystem);

  resetAttributes();

  window.addEventListener('resize', onWindowResize);
  renderer.domElement.addEventListener('pointerdown', e => {
    createFirework(e.clientX / window.innerWidth, e.clientY / window.innerHeight);
    // trigger a drum hit for interactivity
    playDrumHit();
  });

  document.getElementById('launchBtn').addEventListener('click', (e)=>{
    e.preventDefault();
    createFirework(Math.random(), 0.25 + Math.random()*0.5);
    playDrumHit();
  });

  document.getElementById('musicToggle').addEventListener('click', toggleMusic);

  // initial soft bursts
  setTimeout(()=>{ for(let i=0;i<3;i++) setTimeout(()=>createFirework(Math.random(), 0.25+Math.random()*0.5), i*400) }, 600);
}

function resetAttributes(){
  const pos = particleGeometry.attributes.position.array;
  const col = particleGeometry.attributes.customColor.array;
  const alpha = particleGeometry.attributes.alpha.array;
  const size = particleGeometry.attributes.size.array;
  for(let i=0;i<MAX_PARTICLES;i++){
    pos[i*3]=pos[i*3+1]=pos[i*3+2]=9999;
    col[i*3]=col[i*3+1]=col[i*3+2]=0;
    alpha[i]=0.0;
    size[i]=1;
    particleState[i]=null;
  }
  particleGeometry.attributes.position.needsUpdate=true;
  particleGeometry.attributes.customColor.needsUpdate=true;
  particleGeometry.attributes.alpha.needsUpdate=true;
  particleGeometry.attributes.size.needsUpdate=true;
}

function createFirework(normX, normY){
  const x = (normX - 0.5) * (window.innerWidth/window.innerHeight) * 28;
  const y = (1 - normY) * 18 + 2;
  const z = (Math.random()-0.5) * 10;
  launchRocket(new THREE.Vector3(x, 0, z), new THREE.Vector3(0, 0.6 + Math.random()*0.6, 0), y, getPalette());
}

function getPalette(){
  const palettes = [
    [0xffdc00, 0xff6b6b, 0xffb86b, 0x00d2ff],
    [0xff4dff, 0x7c4dff, 0x43e97b, 0xffde59],
    [0xff6bcb, 0xffd56b, 0x8ad4ff, 0xa0ffd6],
    [0xffffff, 0xff9f1c, 0xff1654, 0x0abf5b]
  ];
  return palettes[Math.floor(Math.random()*palettes.length)];
}

function launchRocket(startPos, velocity, explodeHeight, palette){
  particles.push({
    type:'rocket', pos: startPos.clone(), vel: velocity.clone(), age:0, explodeHeight, palette
  });
}

function explode(p){
  const count = 60 + Math.floor(Math.random()*80);
  const speed = 0.8 + Math.random()*2.2;
  for(let i=0;i<count;i++){
    let idx = findFreeParticleIndex();
    if(idx < 0) break;
    const theta = Math.random()*Math.PI*2;
    const phi = Math.acos((Math.random()*2)-1);
    const dir = new THREE.Vector3(Math.sin(phi)*Math.cos(theta), Math.cos(phi), Math.sin(phi)*Math.sin(theta));
    const sp = speed * (0.4 + Math.random()*1.6);
    particleState[idx] = {
      pos: p.pos.clone(),
      vel: dir.multiplyScalar(sp),
      age:0,
      life: PARTICLE_LIFE,
      colorHex: p.palette[Math.floor(Math.random()*p.palette.length)],
      size: 3 + Math.random()*6
    };
    const positions = particleGeometry.attributes.position.array;
    const colors = particleGeometry.attributes.customColor.array;
    const alphas = particleGeometry.attributes.alpha.array;
    const sizes = particleGeometry.attributes.size.array;
    positions[idx*3] = particleState[idx].pos.x;
    positions[idx*3+1] = particleState[idx].pos.y;
    positions[idx*3+2] = particleState[idx].pos.z;
    const c = hexToRgb(particleState[idx].colorHex);
    colors[idx*3]=c.r/255; colors[idx*3+1]=c.g/255; colors[idx*3+2]=c.b/255;
    alphas[idx]=1.0; sizes[idx]=particleState[idx].size;
  }
}

function findFreeParticleIndex(){
  for(let i=0;i<MAX_PARTICLES;i++) if(particleState[i] === null) return i;
  return -1;
}

function hexToRgb(hex){
  const r = (hex >> 16) & 255;
  const g = (hex >> 8) & 255;
  const b = hex & 255;
  return {r,g,b};
}

function animate(){
  requestAnimationFrame(animate);
  const dt = clock.getDelta();

  for(let i=particles.length-1;i>=0;i--){
    const p = particles[i];
    if(p.type === 'rocket'){
      p.age++;
      p.pos.add(p.vel.clone().multiplyScalar(1.0));
      p.vel.add(GRAVITY.clone().multiplyScalar(0.5));
      let idx = findFreeParticleIndex();
      if(idx>=0){
        particleState[idx] = {
          pos: p.pos.clone(),
          vel: new THREE.Vector3((Math.random()-0.5)*0.05, -0.02 + (Math.random()-0.02), (Math.random()-0.5)*0.05),
          age:0, life:30, colorHex:0xfff1b2, size:2 + Math.random()*2
        };
        const positions = particleGeometry.attributes.position.array;
        const colors = particleGeometry.attributes.customColor.array;
        const alphas = particleGeometry.attributes.alpha.array;
        const sizes = particleGeometry.attributes.size.array;
        positions[idx*3]=particleState[idx].pos.x;
        positions[idx*3+1]=particleState[idx].pos.y;
        positions[idx*3+2]=particleState[idx].pos.z;
        const c = hexToRgb(particleState[idx].colorHex);
        colors[idx*3]=c.r/255; colors[idx*3+1]=c.g/255; colors[idx*3+2]=c.b/255;
        alphas[idx]=0.9; sizes[idx]=particleState[idx].size;
      }
      if(p.pos.y >= p.explodeHeight || p.age > 180){
        explode(p);
        particles.splice(i,1);
        // small drum hit on explosion
        playDrumHit();
      }
    }
  }

  const positions = particleGeometry.attributes.position.array;
  const alphas = particleGeometry.attributes.alpha.array;
  const sizes = particleGeometry.attributes.size.array;

  for(let i=0;i<MAX_PARTICLES;i++){
    const s = particleState[i];
    if(s){
      s.age++;
      s.vel.add(GRAVITY);
      s.pos.add(s.vel);
      const lifeFrac = 1 - (s.age / s.life);
      alphas[i] = Math.max(0, lifeFrac);
      sizes[i] = s.size * (0.6 + lifeFrac*0.9);
      positions[i*3]=s.pos.x;
      positions[i*3+1]=s.pos.y;
      positions[i*3+2]=s.pos.z;
      if(s.age >= s.life || s.pos.y < -10){
        particleState[i] = null;
        positions[i*3]=positions[i*3+1]=positions[i*3+2]=9999;
        alphas[i]=0;
      }
    }
  }

  particleGeometry.attributes.position.needsUpdate=true;
  particleGeometry.attributes.alpha.needsUpdate=true;
  particleGeometry.attributes.size.needsUpdate=true;

  const t = Date.now()*0.0002;
  camera.position.x = Math.sin(t)*6;
  camera.lookAt(0,6,0);

  renderer.render(scene, camera);
}

function onWindowResize(){
  camera.aspect = window.innerWidth/window.innerHeight;
  camera.updateProjectionMatrix();
  renderer.setSize(window.innerWidth, window.innerHeight);
}

/* --- Simple WebAudio festive beat generator --- */
let audioCtx = null;
let isPlaying = false;
let masterGain, kickGain, hiGain;
function initAudio(){
  if(audioCtx) return;
  audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  masterGain = audioCtx.createGain(); masterGain.gain.value = 0.6; masterGain.connect(audioCtx.destination);
  kickGain = audioCtx.createGain(); kickGain.gain.value = 0.8; kickGain.connect(masterGain);
  hiGain = audioCtx.createGain(); hiGain.gain.value = 0.25; hiGain.connect(masterGain);
}
function playKick(time){
  const o = audioCtx.createOscillator();
  o.type = 'sine';
  o.frequency.setValueAtTime(120, time);
  o.frequency.exponentialRampToValueAtTime(40, time + 0.15);
  const g = audioCtx.createGain();
  g.gain.setValueAtTime(1, time);
  g.gain.exponentialRampToValueAtTime(0.001, time + 0.25);
  o.connect(g); g.connect(kickGain);
  o.start(time); o.stop(time + 0.3);
}
function playHi(time){
  const o = audioCtx.createOscillator();
  o.type = 'triangle';
  o.frequency.setValueAtTime(1200, time);
  o.frequency.exponentialRampToValueAtTime(900, time + 0.06);
  const g = audioCtx.createGain();
  g.gain.setValueAtTime(0.4, time);
  g.gain.exponentialRampToValueAtTime(0.001, time + 0.12);
  o.connect(g); g.connect(hiGain);
  o.start(time); o.stop(time + 0.15);
}
let beatInterval = null;
function startBeats(){
  initAudio();
  if(isPlaying) return;
  isPlaying = true;
  beatInterval = setInterval(()=>{
    const t0 = audioCtx.currentTime + 0.02;
    playKick(t0);
    playHi(t0 + 0.08);
    setTimeout(()=>{ playKick(audioCtx.currentTime + 0.02); playHi(audioCtx.currentTime + 0.04); }, 220);
  }, 450);
}
function stopBeats(){
  if(!isPlaying) return;
  isPlaying = false;
  clearInterval(beatInterval);
  beatInterval = null;
}
function playDrumHit(){
  if(!audioCtx) return;
  const t = audioCtx.currentTime + 0.01;
  playKick(t);
  playHi(t + 0.02);
}
function toggleMusic(){
  if(!audioCtx) initAudio();
  if(isPlaying){
    stopBeats();
    document.getElementById('musicToggle').innerText = 'Play Beats ðŸ”Š';
  } else {
    if(audioCtx.state === 'suspended') audioCtx.resume();
    startBeats();
    document.getElementById('musicToggle').innerText = 'Pause ðŸ”‡';
  }
}
document.addEventListener('pointerdown', () => {
  if(audioCtx && audioCtx.state === 'suspended') audioCtx.resume();
}, {once:false});

</script>
</body>
</html>
